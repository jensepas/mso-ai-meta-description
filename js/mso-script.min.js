!function(e){"use strict";let t=e("#mso_meta_description_field"),o=e(".mso-char-count"),i=e(".mso-length-indicator"),n=e(".mso-generate-button"),r=e(".mso-ai-generator .spinner"),a=e("#mso-ai-error"),s=e("#content"),l=e("#mso_meta_description_mistral_model"),d=e("#mso_meta_description_gemini_model"),p=e("#mso_meta_description_openai_model"),{selectedGeminiModel:c="",selectedOpenaiModel:m="",selectedMistralModel:g="",geminiApiKeySet:u=!1,openaiApiKeySet:y=!1,mistralApiKeySet:h=!1,selectModel:f="-- Select a Model --",errorLoadingModels:b="Error loading models.",apiKeyMissingError:w="API key not set for this provider.",ajaxUrl:v="",nonce:T=""}="undefined"!=typeof msoScriptVars?msoScriptVars:{},x=()=>{if(!t.length)return;let e=t.val()||"",n=e.length,r="inherit",a="";n>0&&(n<120?(r="orange",a=" (Too short)"):n>160?(r="red",a=" (Too long)"):(r="green",a=" (Good)")),o.text(n),i.text(a).css("color",r)},E=e=>{let t=document.getElementById(e),o=document.getElementById(e+"-button");if(!t||!o)return;let i="password"===t.type;t.type=i?"text":"password";let n=o.querySelector(".dashicons");n&&(n.classList.toggle("dashicons-hidden",!i),n.classList.toggle("dashicons-visibility",i)),o.setAttribute("aria-label",i?"Hide password":"Show password")},S=e=>{let t=document.createElement("div");t.innerHTML=e,t.querySelectorAll("script, style").forEach(e=>e.remove());let o=t.innerText||t.textContent||"";return o.replace(/\[.*?]/g,"").replace(/\s\s+/g," ").trim()},P=async({apiType:t,$select:o,defaultModel:i,apiKeySet:n})=>{if(!o.length)return;o.empty(),o.append(`<option value="">${f}</option>`);let r=e("#mso-model-error-"+t);if(r.text(""),n)o.prop("disabled",!1);else{r.text(w),o.prop("disabled",!0);return}o.siblings(".spinner").css("visibility","visible");try{let a=await fetch(v,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"mso_fetch_models",nonce:T,apiType:t})});if(!a.ok){let s=await a.text();k(`HTTP error ${a.status}: ${s}`)}let l=await a.json();l.success||k(l.data?.message||"Unknown error fetching models.");let d=l.data;d&&Array.isArray(d)&&0!==d.length||k("No compatible models found or returned by the API."),d.forEach(t=>{if(t&&t.id){let n=t.displayName||t.id,r=t.id;o.append(e("<option>",{value:r,text:n,selected:r===i}))}}),i&&o.find(`option[value="${i}"]`).length>0?o.val(i):o.find("option").length>1&&o.prop("selectedIndex",1)}catch(p){console.error(`Error loading ${t} models:`,p),r.text(b+" "+(p.message||"")),o.html(`<option value="">${b}</option>`)}finally{o.siblings(".spinner").css("visibility","hidden")}},_=async e=>{if(t.length){r.css("visibility","visible"),a.text(""),n.prop("disabled",!0);try{let o="";"undefined"!=typeof wp&&wp.data?.select("core/editor")?.getEditedPostContent&&(o=wp.data.select("core/editor").getEditedPostContent()||""),!o&&s.length&&(o=s.val()||""),o||k("Could not retrieve post content.");let i=S(o);i||k("Content is empty after processing.");let l=await fetch(v,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},body:new URLSearchParams({action:"mso_generate_summary",nonce:T,content:i,provider:e})});if(console.log(l),!l.ok){let d=await l.text();try{let p=JSON.parse(d);k(p.data?.message||`HTTP error ${l.status}`)}catch(c){k(`HTTP error ${l.status}: ${d}`)}}let m=await l.json();m.success&&m.data?.summary?t.val(m.data.summary).trigger("input"):k(m.data?.message||"Unknown error during summary generation.")}catch(g){console.error("Summarization Error:",g),a.text("Error: "+(g.message||"Failed to generate summary."))}finally{r.css("visibility","hidden"),n.prop("disabled",!1),x()}}},k=e=>{if(!e)throw Error(e)};e(document).ready(()=>{t.length&&(x(),t.on("keyup input paste change",x),e(".mso-ai-generator").on("click",".mso-generate-button",function(){let t=e(this).data("provider");t&&_(t)})),(l.length||d.length||p.length)&&(P({apiType:"mistral",$select:l,defaultModel:g,apiKeySet:h}),P({apiType:"gemini",$select:d,defaultModel:c,apiKeySet:u}),P({apiType:"openai",$select:p,defaultModel:m,apiKeySet:y}),e('input[type="password"][name^="mso_meta_description_"]').each(function(){let t=e(this).attr("id"),o=e("#"+t+"-button");o.length&&o.on("click",()=>E(t))}))})}(jQuery);